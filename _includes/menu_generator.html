{%- assign mg_open_path = include.open | default: "" -%}
{%- assign mg_last_char = mg_open_path | slice: -1, 1 -%}
{%- if mg_open_path != "" and mg_last_char != "/" -%}
{%-   assign mg_open_path = mg_open_path | append: "/" -%}
{%- endif -%}

{%- assign mg_page_path = include.root | default: "/" -%}
{%- assign mg_last_char = mg_page_path | slice: -1, 1 -%}
{%- unless mg_last_char == "/" -%}
{%-   assign mg_page_path = mg_page_path | append: "/" -%}
{%- endunless -%}

{%- assign mg_sortable = "" | split: "" -%}
{%- assign mg_mypages = site.pages | where: "toc", "true" -%}

{%- for mg_p in mg_mypages -%}
{%-   if mg_p.title -%}
{%-     assign mg_sortkey = mg_p.tocpath | default: mg_p.url -%}
{%-     assign mg_sortkey = mg_sortkey | append: " " -%}
{%-     assign mg_prefix = mg_sortkey | slice: 0, mg_page_path.size -%}
{%-     if mg_prefix == mg_page_path -%}
{%-       capture mg_line -%}
{{ mg_sortkey }}|||{{ mg_p.url }}|||{{ mg_p.title }}
{%-       endcapture -%}
{%-       assign mg_sortable = mg_sortable | push: mg_line -%}
{%-     endif -%}
{%-   endif -%}
{%- endfor -%}

{%- assign mg_sortable = mg_sortable | sort -%}

<div markdown="0">
{%- assign mg_prev_depth = 0 -%}

{%- for mg_entry in mg_sortable -%}
{%-   assign mg_parts = mg_entry | split: "|||" -%}
{%-   assign mg_sortkey = mg_parts[0] | strip -%}
{%-   assign mg_url = mg_parts[1] -%}
{%-   assign mg_title = mg_parts[2] -%}
{%-   assign mg_depth = mg_sortkey | split: "/" | size | minus: 2 -%}
{%-   assign mg_next_entry = mg_sortable[forloop.index] -%}

{%-   if mg_next_entry -%}
{%-     assign mg_next_parts = mg_next_entry | split: "|||" -%}
{%-     assign mg_next_sortkey = mg_next_parts[0] | strip -%}
{%-     assign mg_next_depth = mg_next_sortkey | split: "/" | size | minus: 2 -%}
{%-   else -%}
{%-     assign mg_next_depth = -1 -%}
{%-   endif -%}

{%-   if mg_depth < mg_prev_depth -%}
{%-     for mg_i in (mg_depth..mg_prev_depth-1) -%}
</details>
{%-     endfor -%}
{%-   endif -%}

{%-   assign mg_prefix = mg_open_path | slice: 0, mg_sortkey.size -%}
{%-   assign mg_last_char = mg_open_path | slice: -1, 1 -%}
{%-   unless mg_last_char == "/" -%}
{%-     assign mg_prefix = mg_prefix | append: "/" -%}
{%-   endunless -%}

{%-   if mg_next_depth > mg_depth -%}
{%-     assign mg_is_open = false -%}
{%-     if mg_open_path == "*" or mg_prefix == mg_sortkey -%}
{%-       assign mg_is_open = true -%}
{%-     endif -%}
<details{% if mg_is_open %} open{% endif %}>
<summary><a href="{{ mg_url }}">{{ mg_title }}</a></summary>
{%-   else -%}
{%-     capture mg_page_toc -%}
{%-       include page-toc-old.html url=mg_url strip=true -%}
{%-     endcapture -%}
{%-     if mg_page_toc.size > 0 -%}
{%-       assign mg_is_open = false -%}
{%-       if mg_open_path == "*" or mg_prefix == mg_sortkey -%}
{%-         assign mg_is_open = true -%}
{%-       endif -%}
<details{% if mg_is_open %} open{% endif %}><summary><a href="{{ mg_url }}">{{ mg_title }}</a></summary>{{ mg_page_toc }}</details>
{%-     else -%}
    <p class="listitem"><a href="{{ mg_url }}">{{ mg_title }}</a></p>
{%-     endif -%}
{%-   endif -%}

{%-   assign mg_prev_depth = mg_depth -%}
{%- endfor -%}

{%- assign mg_close_count = mg_prev_depth | minus: mg_depth -%}
{%- for mg_i in (1..mg_close_count) -%}
</details>
{%- endfor -%}
</div>