{%- assign pt_target_url = include.url | default: page.url -%}
{%- assign pt_default_title = include.text | default: "Table of contents" -%}
{%- assign pt_strip = include.strip | default: false -%}
{% for page in site.pages %}
{%   if page.tocpath == pt_target_url or page.url == pt_target_url %}
{%     assign pt_target = page %}
{%   endif %}
{% endfor %}

{%- if pt_target -%}

{%-   assign pt_html = pt_target.content | markdownify -%}
{%-   assign pt_blocks = pt_html | split: "<h" -%}
{%-   if pt_blocks.size > 1 %}
{%      unless pt_strip %}
<details><summary style="font-size:1.2em; font-weight:bold;">{{ pt_default_title }}</summary>
{%      endunless %}
<div class="toc-list">
{%-     assign pt_prev_level = 0 -%}
{%-     for pt_block in pt_blocks offset: 1 -%}

{%-       assign pt_level = pt_block 
          | slice: 0,1 
          | plus: 0 -%}
{%-       assign pt_id = pt_block 
          | split: 'id="' 
          | last 
          | split: '"' 
          | first -%}
{%-       assign pt_title = pt_block 
          | split: "</h" 
          | first 
          | split: ">" 
          | last 
          | strip -%}
        
{%-       if forloop.first -%}
{%-         assign pt_prev_level = pt_level -%}
<ul>
{%-       elsif pt_level > pt_prev_level -%}
{%-         assign pt_diff = pt_level | minus: pt_prev_level -%}
{%-         for i in (1..pt_diff) -%}<ul>{%- endfor -%}
{%-       elsif pt_level < pt_prev_level -%}
{%-         assign pt_diff = pt_prev_level 
            | minus: pt_level -%}
{%-         for i in (1..pt_diff) -%}</li></ul>{%- endfor -%}
</li>
{%-       else -%}
</li>
{%-       endif -%}
<li><a href="{{ pt_target.url }}#{{ pt_id }}">{{ pt_title }}</a>
{%-       assign pt_prev_level = pt_level -%}
{%-       if forloop.last -%}
{%-         assign pt_diff = pt_level 
            | minus: pt_blocks.size 
            | plus: pt_blocks.size -%}
</li>
{%-         for i in (1..pt_prev_level) -%}{% raw %}</ul>{% endraw %}{%- endfor -%}
{%-       endif -%}
{%-     endfor -%}
{% raw %}</div>{% endraw %}
{%-      unless pt_strip -%}
{% raw %}</details>{% endraw %}
{%-      endunless -%}
{%-   endif -%}

{%- endif -%}