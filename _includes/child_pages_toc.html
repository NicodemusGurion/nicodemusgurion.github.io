{%- comment -%}
  Child Pages TOC
  Shows all child pages under the current page with their headers
  Top-level headers shown, deeper headers in collapsible details
{%- endcomment -%}

{%- assign current_page_data = nil -%}

{%- comment -%} Find current page in the flat list {%- endcomment -%}
{%- for page_data in site.data.site_structure.flat -%}
  {%- if page_data.url == page.url -%}
    {%- assign current_page_data = page_data -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Find child pages by comparing file paths {%- endcomment -%}
{%- if current_page_data -%}
  {%- comment -%} Get the directory of the current page {%- endcomment -%}
  {%- assign my_dir = current_page_data.file | split: '/' | pop | join: '/' | append: '/' -%}
  
  {%- assign child_pages = '' | split: '' -%}
  
  {%- for page_data in site.data.site_structure.flat -%}
    {%- comment -%} Skip self {%- endcomment -%}
    {%- if page_data.url == page.url -%}
      {%- continue -%}
    {%- endif -%}
    
    {%- comment -%} Check if file is in the same directory {%- endcomment -%}
    {%- assign page_dir = page_data.file | split: '/' | pop | join: '/' | append: '/' -%}
    
    {%- if page_dir == my_dir and page_data.include_in_menu -%}
      {%- assign child_pages = child_pages | push: page_data -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- if child_pages.size > 0 -%}
<nav class="child-pages-toc">
  <h2>Pages in this section</h2>
  <ul>
    {%- for child in child_pages -%}
      <li>
        <a href="{{ child.url }}">{{ child.title }}</a>
        
        {%- if child.headers.size > 0 -%}
          {%- assign top_headers = '' | split: '' -%}
          {%- assign deep_headers = '' | split: '' -%}
          
          {%- for header in child.headers -%}
            {%- if header.level == 2 -%}
              {%- assign top_headers = top_headers | push: header -%}
            {%- else -%}
              {%- assign deep_headers = deep_headers | push: header -%}
            {%- endif -%}
          {%- endfor -%}
          
          {%- if top_headers.size > 0 or deep_headers.size > 0 -%}
            <ul>
              {%- for header in top_headers -%}
                <li><a href="{{ child.url }}#{{ header.anchor }}">{{ header.text }}</a></li>
              {%- endfor -%}
              
              {%- if deep_headers.size > 0 -%}
                <li>
                  <details>
                    <summary>More sections...</summary>
                    <ul>
                      {%- for header in deep_headers -%}
                        <li><a href="{{ child.url }}#{{ header.anchor }}">{{ header.text }}</a></li>
                      {%- endfor -%}
                    </ul>
                  </details>
                </li>
              {%- endif -%}
            </ul>
          {%- endif -%}
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>
  {%- endif -%}
{%- endif -%}
