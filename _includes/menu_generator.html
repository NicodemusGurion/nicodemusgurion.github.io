{%- assign open_path = include.open | default: "" -%}
{%- assign last_char = open_path | slice: -1, 1 -%}
{%- if open_path != "" and last_char != "/" -%}
{%-   assign open_path = open_path 
      | append: "/" -%}
{%- endif -%}
{%- assign page_path = include.root | default: "/" -%}
{%- assign last_char = page_path | slice: -1, 1 -%}
{%- unless last_char == "/" -%}
{%-   assign page_path = page_path 
      | append: "/" -%}
{%- endunless -%}
{%- assign sortable = "" | split: "" -%}
{%- assign mypages = site.pages | where: "toc", "true" -%}
{%- for p in mypages -%}
{%-   if p.title -%}
{%-     assign sortkey = p.tocpath | default: p.url -%}
{%-     assign sortkey = sortkey | append: " " -%}
{%-     assign prefix = sortkey 
        | slice: 0, page_path.size -%}
{%-     if prefix == page_path -%}
{%-       capture line -%}
{{ sortkey }}|||{{ p.url }}|||{{ p.title }}
{%-       endcapture -%}
{%-       assign sortable = sortable | push: line -%}
{%-     endif -%}
{%-   endif -%}
{%- endfor -%}

{%- assign sortable = sortable | sort -%}

<div markdown="0">
{%- assign prev_depth = 0 -%}

{%- for entry in sortable -%}
{%-   assign parts = entry | split: "|||" -%}
{%-   assign sortkey = parts[0] | strip -%}
{%-   assign url = parts[1] -%}
{%-   assign title = parts[2] -%}
{%-   assign depth = sortkey 
      | split: "/" 
      | size 
      | minus: 2 -%}
{%-   assign next_entry = sortable[forloop.index] -%}
{%-   if next_entry -%}
{%-     assign next_parts = next_entry | split: "|||" -%}
{%-     assign next_sortkey = next_parts[0] | strip -%}
{%-     assign next_depth = next_sortkey | split: "/" | size | minus: 2 -%}
{%-   else -%}
{%-     assign next_depth = -1 -%}
{%-   endif -%}
{%-   if depth < prev_depth -%}
{%-     for i in (depth..prev_depth-1) -%}
</details>
{%-     endfor -%}
{%-   endif -%}
{%-   assign prefix = open_path 
        | slice: 0, sortkey.size -%}
{%-   assign last_char = open_path 
      | slice: -1, 1 -%}
{%-   unless last_char == "/" -%}
{%-     assign prefix = prefix 
        | append: "/" -%}
{%-   endunless -%}
{%-   if next_depth > depth -%}
{%- assign is_open = false -%}
{%- if open_path == "*" or prefix == sortkey -%}
{%- assign is_open = true -%}
{%- endif -%}
<details{% if is_open %} open{% endif %}>
<summary><a href="{{ url }}">{{ title }}</a></summary>
{%-   else -%}
{%-     capture page_toc -%}
{%-       include page-toc.html url=url -%}
{%-     endcapture -%}
{%-     if page_toc.size > 0 %}
{%- assign is_open = false -%}
{%- if open_path == "*" or prefix == sortkey -%}
{%- assign is_open = true -%}
{%- endif -%}
<details{% if is_open %} open{% endif %}><summary><a href="{{ url }}">{{ title }}</a></summary>{{ page_toc }}</details>
{%-     else -%}
    <p class="listitem"><a href="{{ url }}">{{ title }}</a></p>
{%-     endif -%} 
{%-   endif -%}
{%-   assign prev_depth = depth -%}
{%- endfor -%}
{%- assign close_count = prev_depth | minus: depth -%}
{%- for i in (1..close_count) -%}
</details>
{%- endfor -%}
</div>