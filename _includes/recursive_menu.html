{%- assign current_path = include.permalink_path | default: "/" -%}
{%- assign last_char = current_path | slice: -1, 1 -%}
{%- unless last_char == "/" -%}
{%-   assign current_path = current_path 
      | append: "/" -%}
{%- endunless -%}
{%- assign pages_under = "" 
    | split: "" -%}
{%- assign this_page = "" %}
{%- assign all_pages = site.pages 
    | where: "toc", "true" -%}
{%- for p in all_pages -%}
{%-   assign sort_path = p.url -%}
{%-   if p.tocpath -%}
{%-     assign sort_path = p.tocpath -%}
{%-   endif -%}
{%-   if sort_path -%}
{%-     if sort_path == current_path -%}
{%-       assign this_page = p %}
{%-     endif -%}
{%-     assign prefix = sort_path 
        | slice: 0, current_path.size -%}
{%-     if prefix == current_path -%}
{%-       assign pages_under = pages_under | push: p -%}
{%-     endif -%}
{%-   endif -%}
{%- endfor -%}
{%- assign pages_under = pages_under | sort: "url" -%}
{%- if pages_under.size > 0 -%}
{%-   if pages_under.size == 1 and (pages_under[0].url == current_path or pages_under[0].tocpath == current_path) -%}
{%-     assign page = pages_under[0] -%}
{%-     assign html = page.content -%}
{%-     assign parts = html | split: "<h" -%}
{%-     for part in parts -%}
{%-       assign tag_start = part | slice: 0, 1 -%}
{%-       if tag_start == "1" or tag_start == "2" or tag_start == "3" or tag_start == "4" or tag_start == "5" or tag_start == "6" -%}
{%-         assign level = tag_start 
            | plus: 0 -%}
{%-         assign text = part 
            | split: "</h" 
            | first 
            | split: ">" 
            | last %}
{%-         if part contains 'id="' -%}
{%-           assign id = part 
             | split: 'id="' 
             | last 
             | split: '"' 
             | first -%}
{%-         else -%}
{%-           assign id = text
              | downcase
              | replace: " ", "-"
              | replace_regex: "[^a-z0-9\\-]", "" -%}
{%-         endif -%}
<p class="listitem" style="margin-left:{{ level | minus: 1 }}em"><a href="{{ page.url }}#{{ id }}">{{ text }}</a></p>
{%-       endif -%}
{%-     endfor -%}
{%-   else -%}
{%-     assign used_subpaths = "" | split: "" -%}
{%-     for page in pages_under -%}
Processing base {{current_path}}, url {{page.url}}, toc path  {{page.tocpath }}<br>
{%-       assign sort_path = page.url -%}
{%-       if page.tocpath -%}
{%-         assign sort_path = page.tocpath -%}
{%-       endif -%}
{%-       assign subpath = sort_path | remove_first: current_path | split: "/" | first -%}

{%-       unless subpath == "" -%}
{%-         unless used_subpaths contains subpath -%}
{%-           assign used_subpaths = used_subpaths | push: subpath -%}
{%-           assign child_path = current_path | append: subpath -%}
{%-           unless child_path == current_path -%}

{%-             capture subtext -%}
{%-               include recursive_menu.html permalink_path=child_path -%}
{%-             endcapture -%}
{%-             assign subtext = subtext | strip -%}

{%-             if subtext == "" %}
<p class="listitem"><a href="{{ page.url }}">{{ page.title }}</a></p>
{%-             else -%}
<details><summary><a href="{{ page.url }}">{{ page.title }}</a></summary>{{ subtext }}</details>
{%-             endif -%}
{%-           endunless -%}
{%-         endunless -%}
{%-       endunless -%}
Processing next page<br>
{%-     endfor -%}
{%-   endif -%}
{%- endif -%}
{%-  assign current_path = current_path 
      | split: "/" | pop | join: "/" -%}
Popped path: {{ current_path }}<br>