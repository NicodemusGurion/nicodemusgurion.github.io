{% comment %}
  Recursive menu / TOC generator for GitHub Pages.

  Input:
    include.permalink_path  (example: "/", "/topic1/")
{% endcomment %}

{% assign base_path = include.permalink_path | default: "/" %}

{% comment %}
  Collect all pages whose URL starts with base_path
{% endcomment %}
{% assign pages_under = "" | split: "" %}

{% for p in site.pages %}
  {% if p.url %}
    {% assign prefix = p.url | slice: 0, base_path.size %}
    {% if prefix == base_path %}
      {% assign pages_under = pages_under | push: p %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign pages_under = pages_under | sort: "url" %}

{% if pages_under.size == 0 %}
{% else %}

  {% comment %}
    Group pages by the next path segment after base_path
  {% endcomment %}
  {% assign groups = "" | split: "" %}
  {% assign group_keys = "" | split: "" %}

  {% for p in pages_under %}
    {% assign rest = p.url | remove_first: base_path %}
    {% assign segments = rest | split: "/" %}
    {% assign key = segments[0] %}

    {% if key != "" %}
      {% unless group_keys contains key %}
        {% assign group_keys = group_keys | push: key %}
      {% endunless %}
    {% endif %}
  {% endfor %}

  {% assign group_keys = group_keys | sort %}

  {% for key in group_keys %}
    {% assign group_pages = "" | split: "" %}

    {% for p in pages_under %}
      {% assign rest = p.url | remove_first: base_path %}
      {% assign segments = rest | split: "/" %}
      {% if segments[0] == key %}
        {% assign group_pages = group_pages | push: p %}
      {% endif %}
    {% endfor %}

    {% comment %}
      CASE 1: exactly one page -> extract headers
    {% endcomment %}
    {% if group_pages.size == 1 %}
      {% assign page = group_pages[0] %}
      <details>
        <summary>
          <a href="{{ page.url }}">{{ page.title | default: key }}</a>
        </summary>

        {% comment %}
          Parse Markdown headings safely
        {% endcomment %}
        {% for line in page.content | split: "\n" %}
          {% assign trimmed = line | strip %}
          {% if trimmed != "" and trimmed contains "#" %}
            {% assign first_char = trimmed | slice: 0, 1 %}
            {% if first_char == "#" %}
              {% assign hashes = trimmed | split: " " | first %}
              {% assign level = hashes | size %}
              {% assign text = trimmed | remove_first: hashes | strip %}

              {% comment %}
                Handle optional custom ID {#id}
              {% endcomment %}
              {% if text contains "{#" %}
                {% assign parts = text | split: "{#" %}
                {% assign text = parts[0] | strip %}
                {% assign id = parts[1] | remove: "}" | strip %}
              {% else %}
                {% assign id = text
                  | downcase
                  | replace: " ", "-"
                  | replace_regex: "[^a-z0-9\\-]", "" %}
              {% endif %}

              <p style="margin-left:{{ level | minus: 1 }}em">
                <a href="{{ page.url }}#{{ id }}">{{ text }}</a>
              </p>
            {% endif %}
          {% endif %}
        {% endfor %}
      </details>

    {% comment %}
      CASE 2: multiple pages -> recurse deeper
    {% endcomment %}
    {% else %}
      <details>
        <summary>{{ key }}</summary>
        {% assign new_path = base_path | append: key | append: "/" %}
        {% include recursive_menu.html permalink_path=new_path %}
      </details>
    {% endif %}
  {% endfor %}

{% endif %}