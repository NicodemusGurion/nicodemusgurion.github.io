{%- comment -%}
  Child Pages TOC
  Shows all child pages under the current page with their headers
  Uses tocpath for hierarchy, URL for links
{%- endcomment -%}

{%- assign current_page_data = nil -%}

{%- comment -%} Find current page in the flat list {%- endcomment -%}
{%- for page_data in site.data.site_structure.flat -%}
  {%- if page_data.url == page.url -%}
    {%- assign current_page_data = page_data -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Find child pages based on URL/tocpath hierarchy {%- endcomment -%}
{%- if current_page_data -%}
  {%- comment -%} Determine the path to use for finding children {%- endcomment -%}
  {%- assign my_path = current_page_data.tocpath | default: current_page_data.url -%}
  
  {%- comment -%} Normalize path - ensure ends with / {%- endcomment -%}
  {%- unless my_path contains '/' -%}
    {%- assign my_path = my_path | append: '/' -%}
  {%- endunless -%}
  {%- unless my_path == '/' -%}
    {%- unless my_path contains '/' at -1 -%}
      {%- assign my_path = my_path | append: '/' -%}
    {%- endunless -%}
  {%- endunless -%}
  
  {%- assign child_pages = '' | split: '' -%}
  
  {%- for page_data in site.data.site_structure.flat -%}
    {%- comment -%} Skip self {%- endcomment -%}
    {%- if page_data.url == page.url -%}
      {%- continue -%}
    {%- endif -%}
    
    {%- comment -%} Get the page's organizational path {%- endcomment -%}
    {%- assign page_path = page_data.tocpath | default: page_data.url -%}
    
    {%- comment -%} Check if this page is a direct child {%- endcomment -%}
    {%- if page_path contains my_path -%}
      {%- comment -%} Remove parent path to see what's left {%- endcomment -%}
      {%- assign remainder = page_path | remove_first: my_path -%}
      
      {%- comment -%} Count slashes - if 0 or 1, it's a direct child {%- endcomment -%}
      {%- assign slash_count = remainder | split: '/' | size -%}
      {%- if slash_count <= 2 and page_data.include_in_menu -%}
        {%- assign child_pages = child_pages | push: page_data -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- if child_pages.size > 0 -%}
<nav class="child-pages-toc">
  <h2>Pages in this section</h2>
  <ul>
    {%- for child in child_pages -%}
      <li>
        <a href="{{ child.url }}">{{ child.title }}</a>
        
        {%- if child.headers.size > 0 -%}
          {%- assign top_headers = '' | split: '' -%}
          {%- assign deep_headers = '' | split: '' -%}
          
          {%- for header in child.headers -%}
            {%- if header.level == 2 -%}
              {%- assign top_headers = top_headers | push: header -%}
            {%- else -%}
              {%- assign deep_headers = deep_headers | push: header -%}
            {%- endif -%}
          {%- endfor -%}
          
          {%- if top_headers.size > 0 or deep_headers.size > 0 -%}
            <ul>
              {%- for header in top_headers -%}
                <li><a href="{{ child.url }}#{{ header.anchor }}">{{ header.text }}</a></li>
              {%- endfor -%}
              
              {%- if deep_headers.size > 0 -%}
                <li>
                  <details>
                    <summary>More sections...</summary>
                    <ul>
                      {%- for header in deep_headers -%}
                        <li><a href="{{ child.url }}#{{ header.anchor }}">{{ header.text }}</a></li>
                      {%- endfor -%}
                    </ul>
                  </details>
                </li>
              {%- endif -%}
            </ul>
          {%- endif -%}
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>
  {%- endif -%}
{%- endif -%}
