{%- assign page_path = include.page_path | default: page.url -%}

{%- assign page = site.pages | where: "url", page_path | first -%}
{%- if page -%}

{%- assign lines = page.content | split: "\n" -%}

{%- for line in lines -%}
  {%- assign trimmed = line | strip -%}

  {%- if trimmed startswith "#" -%}
    {%- assign hashes = trimmed | split: " " | first -%}
    {%- assign level = hashes | size -%}

    {%- if level >= 1 and level <= 6 -%}
      {%- assign text = trimmed | remove_first: hashes | strip -%}

      {%- assign id = text
        | downcase
        | replace: " ", "-"
        | replace_regex: "[^a-z0-9\\-]", "" -%}

<p class="listitem" style="margin-left:{{ level | minus: 1 }}em">
  <a href="#{{ id }}">{{ text }}</a>
</p>

    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- endif -%}