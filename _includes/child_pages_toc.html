{%- comment -%}
Display table of contents for child pages of the current page
{%- endcomment -%}

{%- assign current_url = page.url -%}
{%- assign current_tocpath = page.tocpath | default: current_url -%}

{%- comment -%}Normalize current path{%- endcomment -%}
{%- if current_tocpath == "/" -%}
  {%- assign normalized_current = "/" -%}
{%- else -%}
  {%- assign normalized_current = current_tocpath | remove_first: "/" | remove: "/" -%}
{%- endif -%}

{%- comment -%}Find child pages{%- endcomment -%}
{%- assign child_pages = site.data.site_structure.pages | where_exp: "item", "item.url != current_url" -%}

{%- comment -%}Filter to only direct children{%- endcomment -%}
{%- assign children = "" | split: "" -%}
{%- for item in child_pages -%}
  {%- assign item_tocpath = item.tocpath | default: item.url -%}
  
  {%- comment -%}Normalize item path{%- endcomment -%}
  {%- if item_tocpath == "/" -%}
    {%- assign normalized_item = "/" -%}
  {%- else -%}
    {%- assign normalized_item = item_tocpath | remove_first: "/" | remove: "/" -%}
  {%- endif -%}
  
  {%- comment -%}Check if this item is a direct child{%- endcomment -%}
  {%- if normalized_current == "/" -%}
    {%- assign segments = normalized_item | split: "/" -%}
    {%- if segments.size == 1 -%}
      {%- assign children = children | push: item -%}
    {%- endif -%}
  {%- else -%}
    {%- if normalized_item contains normalized_current -%}
      {%- assign item_remainder = normalized_item | remove_first: normalized_current | remove_first: "/" -%}
      {%- assign remainder_segments = item_remainder | split: "/" -%}
      {%- if remainder_segments.size == 1 and item_remainder != "" -%}
        {%- assign children = children | push: item -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- if children.size > 0 -%}
<nav class="child-pages-toc">
  <h2>Child Pages</h2>
{%- for child in children -%}
  <details open>
    <summary><a href="{{ child.url }}">{{ child.title }}</a></summary>{%- if child.headers.size > 0 -%}{%- assign output = "" -%}{%- assign level_stack = "" | split: "" -%}{%- for header in child.headers -%}{%- assign current_level = header.level -%}{%- assign last_level = level_stack | last | default: 0 -%}{%- if current_level > last_level -%}{%- assign level_stack = level_stack | push: current_level -%}{%- elsif current_level < last_level -%}{%- assign diff = last_level | minus: current_level -%}{%- for i in (1..diff) -%}{%- capture closing -%}</details>{%- endcapture -%}{%- assign output = output | append: closing -%}{%- assign level_stack = level_stack | pop -%}{%- endfor -%}{%- endif -%}{%- assign next_index = forloop.index -%}{%- assign next_header = child.headers[next_index] -%}{%- if next_header and next_header.level > current_level -%}{%- capture node -%}<details><summary><a href="{{ child.url }}#{{ header.anchor }}">{{ header.text }}</a></summary>{%- endcapture -%}{%- assign output = output | append: node -%}{%- else -%}{%- capture node -%}<p class="listitem level-{{ header.level }}"><a href="{{ child.url }}#{{ header.anchor }}">{{ header.text }}</a></p>{%- endcapture -%}{%- assign output = output | append: node -%}{%- endif -%}{%- if forloop.last -%}{%- for level in level_stack -%}{%- capture closing -%}</details>{%- endcapture -%}{%- assign output = output | append: closing -%}{%- endfor -%}{%- endif -%}{%- endfor -%}{{ output }}{%- endif -%}
  </details>
{%- endfor -%}
</nav>
{%- endif -%}
