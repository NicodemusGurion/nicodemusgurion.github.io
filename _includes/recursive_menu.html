{%- comment -%}
  Recursive menu / TOC generator
  GitHub Pages compatible
{%- endcomment -%}

{%- assign base_path = include.permalink_path | default: "/" -%}
{%- comment -%}This incursion base path: {{base_path}}<br>{%- endcomment -%}
{%- assign last_char = base_path | slice: -1, 1 -%}
{%- unless last_char == "/" -%}
  {%- assign base_path = base_path | append: "/" -%}
  {%- comment -%}New base path: {{ base_path }}<br>{%- endcomment -%}
{%- endunless -%}

{%- assign pages_under = "" | split: "" -%}
{%- assign this_page = "" %}
{%- for p in site.pages -%}
  {%- if p.url -%}
    {%- if p.url == base_path -%}
      {%- assign this_page = p %}
    {%- endif -%}
    {%- assign prefix = p.url | slice: 0, base_path.size -%}
    {%- if prefix == base_path -%}
      {%- assign pages_under = pages_under | push: p -%}
      {%- comment -%}Adding the page {{ p.url }} to list<br>{%- endcomment -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- assign pages_under = pages_under | sort: "url" -%}
{%- if pages_under.size > 0 -%}
{%- if pages_under.size == 1 and pages_under[0].url == base_path -%}
{%- comment -%}Doing single page <br>{%- endcomment -%}
{%- assign page = pages_under[0] -%}
<details><summary><a href="{{ page.url }}">{{ page.title }}</a></summary>
{%- assign html = page.content -%}
{%- assign parts = html | split: "<h" -%}
{%- for part in parts -%}
  {%- assign tag_start = part | slice: 0, 1 -%}
  {%- if tag_start == "1" or tag_start == "2" or tag_start == "3" or tag_start == "4" or tag_start == "5" or tag_start == "6" -%}
    {%- assign level = tag_start | plus: 0 -%}
    {%- assign text = part | split: "</h" | first | split: ">" | last %}
    {%- if part contains 'id="' -%}
      {%- assign id = part | split: 'id="' | last | split: '"' | first -%}
    {%- else -%}
      {%- assign id = text
        | downcase
        | replace: " ", "-"
        | replace_regex: "[^a-z0-9\\-]", "" -%}
    {%- endif -%}
<p style="margin-left:{{ level | minus: 1 }}em"><a href="{{ page.url }}#{{ id }}">{{ text }}</a></p>
  {%- endif -%}
{%- endfor -%}
</details>
      
{%- else -%}
{%- comment -%}Doing multiple pages <br>{%- endcomment -%}

{%- if this_page != "" -%}
<details><summary><a href="{{ this_page.url }}">{{ this_page.title }}</a></summary>
{%- endif -%}
  {%- assign used_subpaths = "" | split: "" -%}
  {%- for page in pages_under -%}
  {%- comment -%}page url: {{ page.url }}<br>
  Base path: {{ base_path }}<br>{%- endcomment -%}
  {%- assign subpath = page.url | remove_first: base_path | split: "/" | first -%}
  {%- unless subpath == "" -%}
  {%- comment -%}Subpath: {{ subpath }}<br>{%- endcomment -%}
    {%- unless used_subpaths contains subpath -%}
    {%- comment -%}New subpaths<br>{%- endcomment -%}
  {%- assign used_subpaths = used_subpaths | push: subpath -%}
        {%- assign new_path = base_path | append: subpath -%}
        
        {%- unless new_path == base_path -%}
{%- comment -%}Recursing, new path: {{ new_path }}<br>{%- endcomment -%}
{%- assign old_path = base_path -%}
{%- comment -%}Base path before recursing {{ base_path }}<br>{%- endcomment -%}
  {%- include recursive_menu.html permalink_path=new_path -%}
Base path after recursing {{ base_path }}<br>
{%- assign base_path = old_path -%}
{%- comment -%}Returning from recursion to {{ base_path }}<br>{%- endcomment -%}
        {%- endunless -%}
        
 
    {%- endunless -%}
   {%- endunless -%}
  {%- endfor -%}
  
{%- if this_page != "" -%}
</details>
{%- endif -%}

{%- endif -%}
{%- endif -%}