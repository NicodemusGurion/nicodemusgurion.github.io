{% comment %}
  Recursive menu generator.
  Input:
    - permalink_path: the prefix of permalinks to start at (e.g., "/topic1/")
{% endcomment %}

{% assign permalink_path = include.permalink_path | default: "/" %}

{% comment %}
  Filter all pages whose permalink begins with the given path
{% endcomment %}
{% assign pages_under_path = site.pages | where_exp: "p", "p.url startswith permalink_path" | sort: "url" %}

{% comment %}
  If no pages, stop recursion
{% endcomment %}
{% if pages_under_path.size == 0 %}
No pages under {{ permalink_path }}. 
  {% return %}
{% endif %}

{% comment %}
  Group pages by the next segment in the path
{% endcomment %}
{% assign groups = {} %}

{% for p in pages_under_path %}
  {% assign relative_path = p.url | remove_first: permalink_path %}
  {% assign segments = relative_path | split: '/' | reject: '' %}
  {% assign first_segment = segments[0] %}
  
  {% if first_segment %}
    {% if groups[first_segment] == nil %}
      {% assign groups = groups | merge: {{ first_segment }}: [] %}
    {% endif %}
    {% assign groups[first_segment] = groups[first_segment] | push: p %}
  {% endif %}
{% endfor %}
Groups {{ groups }}. 

{% comment %}
  Process each group
{% endcomment %}
{% for key in groups %}
Group key {{ key }}. 
  {% assign group_pages = groups[key] %}
  
  {% if group_pages.size == 1 %}
    {% comment %}
      Only one page in this subpath: render headers
    {% endcomment %}
    {% assign page = group_pages[0] %}
    <details>
      <summary><a href="{{ page.url }}">{{ page.title }}</a></summary>

      {% comment %}
        Scan page Markdown for headings
      {% endcomment %}
      {% for line in page.content | split: "\n" %}
        {% if line contains "#" %}
          {% assign heading_match = line | regex_match: "^(#+)\\s+(.*)" %}
          {% if heading_match %}
            {% assign level = heading_match[1] | size %}
            {% assign text = heading_match[2] %}
            {% assign id_match = text | regex_match: "(.*)\\s*\\{#([a-zA-Z0-9-_]+)\\}$" %}
            {% if id_match %}
              {% assign text = id_match[1] | strip %}
              {% assign id = id_match[2] %}
            {% else %}
              {% assign id = text | downcase | replace: " ", "-" | replace_regex: "[^a-z0-9\\-]", "" %}
            {% endif %}
            <p style="margin-left:{{ level | minus:1 }}em">
              <a href="{{ page.url }}#{{ id }}">{{ text }}</a>
            </p>
          {% endif %}
        {% endif %}
      {% endfor %}
    </details>
  
  {% else %}
    {% comment %}
      More than one page: recurse into the subpath
      Determine new permalink path for recursion
    {% endcomment %}
    <details>
      <summary>{{ key }}</summary>
      {% include recursive_menu.html permalink_path=permalink_path | append: key | append: "/" %}
    </details>
  {% endif %}
{% endfor %}