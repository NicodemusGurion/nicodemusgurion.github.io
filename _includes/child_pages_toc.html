{% comment %}
Display table of contents for child pages of the current page
{% endcomment %}

{% assign current_url = page.url %}
{% assign current_tocpath = page.tocpath | default: current_url %}

{% comment %}Normalize current path{% endcomment %}
{% if current_tocpath == "/" %}
  {% assign normalized_current = "/" %}
{% else %}
  {% assign normalized_current = current_tocpath | remove_first: "/" | remove: "/" %}
{% endif %}

{% comment %}Find child pages{% endcomment %}
{% assign child_pages = site.data.site_structure.pages | where_exp: "item", "item.url != current_url" %}

{% comment %}Filter to only direct children{% endcomment %}
{% assign children = "" | split: "" %}
{% for item in child_pages %}
  {% assign item_tocpath = item.tocpath | default: item.url %}
  
  {% comment %}Normalize item path{% endcomment %}
  {% if item_tocpath == "/" %}
    {% assign normalized_item = "/" %}
  {% else %}
  {% assign compare_normalized_item = item_tocpath | remove_first: "/" %}
    {% assign normalized_item = item_tocpath | remove_first: "/" | remove: "/" %}
  {% endif %}
  
  {% comment %}Check if this item is a direct child{% endcomment %}
  {% if normalized_current == "/" %}
    {% assign segments = normalized_item | split: "/" %}
    {% if segments.size == 1 %}
      {% assign children = children | push: item %}
    {% endif %}
  {% else %}
  {% assign compare_normalized_current = normalized_current | append: "/" %}
    {% if compare_normalized_item contains compare_normalized_current %}
      {% assign item_remainder = normalized_item | remove_first: normalized_current | remove_first: "/" %}
      {% assign remainder_segments = item_remainder | split: "/" %}
      {% if remainder_segments.size == 1 and item_remainder != "" %}
        {% assign children = children | push: item %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}Sort children by nav_order{% endcomment %}
{% assign sorted_children = children | sort: "nav_order" %}

{% if sorted_children.size > 0 %}

<nav class="child-pages-toc">

{%   for child in sorted_children %}
{%     if child.headers.size > 0 %}

  <details open>
    <summary><a href="{{ child.url }}">{{ child.title }}</a></summary>

{%       assign prev_level = 0 %}
{%       assign current_level = 0 %}
{%       for header in child.headers %}
{%         assign current_level = header.level %}
{%         if current_level < prev_level %}
{%           assign difference = prev_level | minus: current_level %}
{%           for i in (1..difference) %}
</details>
{%           endfor %}
{%         endif %}

{%         assign has_children = false %}
{%         if forloop.index < child.headers.size %}
{%           assign next_header = child.headers[forloop.index] %}
{%           if next_header.level > current_level %}
{%             assign has_children = true %}
{%           endif %}
{%         endif %}

{%         if has_children %}

<details><summary><a href="{{ child.url }}#{{ header.anchor }}">{{ header.text }}</a></summary> 

{%         else %}

<p class="listitem level-{{ header.level }}"><a href="{{ child.url }}#{{ header.anchor }}">{{ header.text }}</a></p>

{%         endif %}
{%           assign prev_level = current_level %}

{%       endfor %}


{%       if current_level > 0 %}
{%         for i in (1..current_level) %}
</details>
{%         endfor %}
{%       endif %}
{%     else %}

<p class="listitem"><a href="{{ child.url }}">{{ child.title }}</a></p>

{%     endif %}
<br>
{%   endfor %}
   

</nav>

{% endif %}
